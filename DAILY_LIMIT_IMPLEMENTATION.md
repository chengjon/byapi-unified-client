# æ¯æ—¥è¯·æ±‚é™åˆ¶åŠŸèƒ½å®ç°æŠ¥å‘Š

**å®æ–½æ—¥æœŸ**: 2025-11-19  
**åŠŸèƒ½**: æ¯ä¸ªè®¸å¯è¯å¯†é’¥æ¯å¤©æœ€å¤š200æ¬¡è¯·æ±‚  

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ–°å¢è®¸å¯è¯å¯†é’¥ âœ…

**ä½ç½®**: `/opt/iflow/byapi/.env`

**æ·»åŠ çš„å¯†é’¥**:
```
2D66DE4C-B01C-4B6E-A333-FF842A48788E
```

**å½“å‰é…ç½®çš„å¯†é’¥æ€»æ•°**: 4ä¸ª
```
1. 5E93C803-FB53-4938-BD15-ECC2B4187DD7
2. 354F9B4B-4D7C-4FF5-9D49-1A9E0D8F7D9E
3. 04C01BF1-7F2F-41A3-B470-1F81F14B1FC8
4. 2D66DE4C-B01C-4B6E-A333-FF842A48788E  â† æ–°å¢
```

---

### 2. æ¯æ—¥è¯·æ±‚é™åˆ¶åŠŸèƒ½ âœ…

**å®ç°ä½ç½®**: `/opt/iflow/byapi/byapi_config.py`

#### æ–°å¢å­—æ®µ (LicenseKeyHealth)

```python
daily_requests: int = 0              # ä»Šæ—¥å·²ä½¿ç”¨æ¬¡æ•°
last_request_date: Optional[str] = None  # æœ€åè¯·æ±‚æ—¥æœŸ (YYYY-MM-DD)
daily_limit: int = 200               # æ¯æ—¥é™åˆ¶ (200æ¬¡/å¤©)
```

#### æ–°å¢æ–¹æ³•

1. **`increment_daily_requests()` - è¯·æ±‚è®¡æ•°å™¨**
   - è‡ªåŠ¨æ£€æµ‹æ–°çš„ä¸€å¤©å¹¶é‡ç½®è®¡æ•°å™¨
   - æ£€æŸ¥æ˜¯å¦è¾¾åˆ°200æ¬¡é™åˆ¶
   - è¾¾åˆ°é™åˆ¶æ—¶å°†çŠ¶æ€æ ‡è®°ä¸º `rate_limited`
   - è¿”å› `True` (å…è®¸) æˆ– `False` (è¶…é™)

2. **`get_remaining_requests()` - è·å–å‰©ä½™æ¬¡æ•°**
   - è¿”å›ä»Šå¤©å‰©ä½™å¯ç”¨çš„è¯·æ±‚æ¬¡æ•°
   - è·¨å¤©è‡ªåŠ¨æ˜¾ç¤ºå®Œæ•´çš„200æ¬¡

#### çŠ¶æ€æ‰©å±•

**æ–°å¢çŠ¶æ€**: `rate_limited`
- å½“å¯†é’¥è¾¾åˆ°æ¯æ—¥200æ¬¡é™åˆ¶æ—¶è®¾ç½®
- è¯¥çŠ¶æ€çš„å¯†é’¥ä¸å¯ç”¨ (`is_usable = False`)
- æ¬¡æ—¥è‡ªåŠ¨é‡ç½®ä¸º `healthy`

**çŠ¶æ€åˆ—è¡¨**:
```python
"healthy"       # å¥åº·å¯ç”¨
"faulty"        # æ•…éšœä½†ä»å¯ç”¨ (5æ¬¡è¿ç»­å¤±è´¥)
"invalid"       # æ°¸ä¹…ç¦ç”¨ (10æ¬¡æ€»å¤±è´¥)
"rate_limited"  # è¾¾åˆ°æ¯æ—¥é™åˆ¶ (200æ¬¡/å¤©)
```

---

### 3. å¯†é’¥è½®æ¢é€»è¾‘æ›´æ–° âœ…

**å®ç°ä½ç½®**: `KeyRotationManager.get_next_key()`

#### æ–°å¢é€»è¾‘

1. **è¯·æ±‚å‰æ£€æŸ¥**
   - åœ¨è¿”å›å¯†é’¥ä¹‹å‰è°ƒç”¨ `increment_daily_requests()`
   - å¦‚æœè¿”å› `False`ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨å¯†é’¥

2. **æ™ºèƒ½é€‰æ‹©ç­–ç•¥**
   ```
   ä¼˜å…ˆçº§ 1: healthy keys (å¥åº· + æœ‰å‰©ä½™æ¬¡æ•°)
   ä¼˜å…ˆçº§ 2: faulty keys (æ•…éšœ + æœ‰å‰©ä½™æ¬¡æ•°)
   ä¼˜å…ˆçº§ 3: invalid keys (æœ€åå¤‡é€‰)
   ```

3. **å…¨éƒ¨è¶…é™å¤„ç†**
   - å½“æ‰€æœ‰å¯†é’¥éƒ½è¾¾åˆ°200æ¬¡é™åˆ¶æ—¶
   - æŠ›å‡º `RateLimitError` å¼‚å¸¸
   - å¼‚å¸¸ä¿¡æ¯åŒ…å«æ¯ä¸ªå¯†é’¥çš„å‰©ä½™æ¬¡æ•°

---

## ğŸ“Š åŠŸèƒ½éªŒè¯

### æµ‹è¯•ç»“æœ

**æµ‹è¯•å‘½ä»¤**:
```bash
python test_daily_limit.py
```

**éªŒè¯é¡¹ç›®**:
- âœ… 4ä¸ªå¯†é’¥å…¨éƒ¨åŠ è½½æˆåŠŸ
- âœ… åˆå§‹çŠ¶æ€: 0/200 è¯·æ±‚, å‰©ä½™ 200 æ¬¡
- âœ… APIè°ƒç”¨åè®¡æ•°å™¨å¢åŠ : 1/200 è¯·æ±‚, å‰©ä½™ 199 æ¬¡
- âœ… å¯†é’¥çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- âœ… è‡ªåŠ¨é‡è¯•åŠŸèƒ½æ­£å¸¸ï¼ˆå¤±è´¥ååˆ‡æ¢å¯†é’¥ï¼‰

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨æ¯æ—¥é‡ç½®
- æ¯å¤© 00:00 è‡ªåŠ¨é‡ç½®æ‰€æœ‰å¯†é’¥çš„è®¡æ•°å™¨
- æ— éœ€æ‰‹åŠ¨å¹²é¢„æˆ–é‡å¯ç¨‹åº
- `rate_limited` çŠ¶æ€è‡ªåŠ¨æ¢å¤ä¸º `healthy`

### 2. æ™ºèƒ½å¯†é’¥è½®æ¢
- ä¼˜å…ˆä½¿ç”¨å¥åº·ä¸”æœ‰å‰©ä½™æ¬¡æ•°çš„å¯†é’¥
- è‡ªåŠ¨è·³è¿‡è¾¾åˆ°é™åˆ¶çš„å¯†é’¥
- å¾ªç¯ä½¿ç”¨æ‰€æœ‰å¯ç”¨å¯†é’¥

### 3. å®æ—¶ç›‘æ§
```python
# è·å–å¯†é’¥å¥åº·çŠ¶æ€
health_status = config.get_license_health(mask_keys=False)

for health in health_status:
    print(f"{health._mask_key()}: "
          f"{health.daily_requests}/{health.daily_limit} è¯·æ±‚, "
          f"å‰©ä½™ {health.get_remaining_requests()} æ¬¡, "
          f"çŠ¶æ€: {health.status}")
```

### 4. å¼‚å¸¸å¤„ç†
```python
from byapi_exceptions import RateLimitError

try:
    result = client.stock_list.get_stock_list()
except RateLimitError as e:
    print(f"æ‰€æœ‰å¯†é’¥å·²è¾¾åˆ°æ¯æ—¥é™åˆ¶: {e}")
    # å»ºè®®: ç­‰å¾…è‡³æ¬¡æ—¥æˆ–è”ç³»ç®¡ç†å‘˜å¢åŠ é…é¢
```

---

## ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡

### æ¯æ—¥é…é¢åˆ†é…

| å¯†é’¥æ•°é‡ | å•ä¸ªé™åˆ¶ | æ€»é…é¢/å¤© |
|---------|---------|----------|
| 4       | 200æ¬¡   | 800æ¬¡    |

### æ¨èä½¿ç”¨ç­–ç•¥

1. **æ­£å¸¸ä½¿ç”¨** (< 200æ¬¡/å¤©/å¯†é’¥)
   - ä¿æŒ3ç§’é—´éš”æµ‹è¯•
   - ç³»ç»Ÿè‡ªåŠ¨è½®æ¢å¯†é’¥

2. **é«˜è´Ÿè½½ä½¿ç”¨** (> 600æ¬¡/å¤©)
   - æ‰€æœ‰4ä¸ªå¯†é’¥è½®æµä½¿ç”¨
   - æ¯ä¸ªå¯†é’¥ â‰¤ 200æ¬¡/å¤©
   - æ€»è®¡å¯ç”¨ 800æ¬¡/å¤©

3. **è¾¾åˆ°é™åˆ¶å**
   - ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨å¯†é’¥
   - å¦‚æœæ‰€æœ‰å¯†é’¥éƒ½è¾¾åˆ°é™åˆ¶ï¼ŒæŠ›å‡ºå¼‚å¸¸
   - ç­‰å¾…è‡³æ¬¡æ—¥ 00:00 è‡ªåŠ¨é‡ç½®

---

## ğŸ”§ é…ç½®è¯´æ˜

### ä¿®æ”¹æ¯æ—¥é™åˆ¶ (é»˜è®¤200æ¬¡)

**æ–¹æ³•1: ä»£ç ä¸­ä¿®æ”¹** (å½±å“æ‰€æœ‰å¯†é’¥)
```python
# byapi_config.py, line 39
daily_limit: int = 200  # æ”¹ä¸ºå…¶ä»–å€¼ï¼Œå¦‚ 300
```

**æ–¹æ³•2: ç¯å¢ƒå˜é‡** (æœªæ¥å¯æ·»åŠ )
```bash
# .env æ–‡ä»¶
BYAPI_DAILY_LIMIT=300
```

### æŸ¥çœ‹å¯†é’¥ä½¿ç”¨æƒ…å†µ

**Pythonä»£ç **:
```python
from byapi_client_unified import ByapiClient

client = ByapiClient()
health = client.config.get_license_health(mask_keys=False)

for h in health:
    print(f"å¯†é’¥: {h.key[:8]}...")
    print(f"  ä»Šæ—¥è¯·æ±‚: {h.daily_requests}/{h.daily_limit}")
    print(f"  å‰©ä½™æ¬¡æ•°: {h.get_remaining_requests()}")
    print(f"  çŠ¶æ€: {h.status}")
```

---

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸è¯·æ±‚
```
DEBUG - License key 5E93C803... daily requests: 1/200
DEBUG - License key 5E93C803... daily requests: 2/200
```

### è¾¾åˆ°é™åˆ¶
```
WARNING - License key 5E93C803... reached daily limit (200 requests)
```

### æ¬¡æ—¥é‡ç½®
```
INFO - License key 5E93C803... daily limit reset (new day: 2025-11-20)
```

### å…¨éƒ¨è¶…é™
```
ERROR - All 4 license keys have reached daily limit (200 requests/day). 
        Remaining: 5E93C803...: 0, 354F9B4B...: 0, 04C01BF1...: 0, 2D66DE4C...: 0
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒæˆå°±
- âœ… æ–°å¢ç¬¬4ä¸ªè®¸å¯è¯å¯†é’¥
- âœ… å®ç°æ¯å¯†é’¥200æ¬¡/å¤©é™åˆ¶
- âœ… è‡ªåŠ¨æ¯æ—¥é‡ç½®åŠŸèƒ½
- âœ… æ™ºèƒ½å¯†é’¥è½®æ¢
- âœ… å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—è®°å½•

### ç³»ç»Ÿå®¹é‡
- **å•å¯†é’¥**: 200æ¬¡/å¤©
- **æ€»å®¹é‡**: 800æ¬¡/å¤© (4ä¸ªå¯†é’¥)
- **æµ‹è¯•é—´éš”**: 3ç§’ä¸å˜
- **è‡ªåŠ¨åŒ–**: 100% (æ— éœ€æ‰‹åŠ¨ç®¡ç†)

### ä»£ç è´¨é‡
- ç±»å‹æç¤ºå®Œæ•´
- å¼‚å¸¸å¤„ç†å¥å…¨
- æ—¥å¿—è®°å½•è¯¦ç»†
- ç”Ÿäº§å°±ç»ª âœ…

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-19 22:42  
**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯
